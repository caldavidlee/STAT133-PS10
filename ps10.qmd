---
title: "Problem Set 10"
format: 
    dashboard:
        orientation: columns
        nav-buttons: 
            - icon: github
              href: https://github.com/caldavidlee/STAT133-PS10
            - icon: linkedin
              href: https://www.linkedin.com/in/davidthelee/
            - icon: twitter
              href: http://x.com/divarnold/
        logo: stat133_logo-main.png
author: David Lee
theme: minty
---



```{r}
#install.packages(c("gt", "httr2", "shiny"))

```
```{r}
#| label: setup
#| message: false
library(tidyverse)
library(httr2)
library(sf)
library(leaflet)
library(gt)
library(shiny)
```

```{r}
#| label: "Get quake data"
quakes_raw <- request("https://api.geonet.org.nz/quake?MMI=3") |>
  req_headers("Accept"="application/vnd.geo+json") |>
  req_perform() |>
  resp_body_string() |> 
  st_read(quiet = TRUE)
```

```{r}
#| label: "Prettier date/times"
recent_quakes <- quakes_raw |> 
  arrange(desc(time)) |> 
  mutate(
    time = force_tz(time, "Pacific/Auckland"),
    pretty_time = format(time, "%I:%M %p"),
    days_ago = today(tzone = "Pacific/Auckland") - date(time),
    days_ago = case_when(
      days_ago == 0 ~ "Today",
      days_ago == 1 ~ "Yesterday",
      TRUE ~ paste0(days_ago, " days ago")
    )
  )
```

```{r}
#| label: "Summary stats"
now_nz <- now(tzone = "Pacific/Auckland")
last_24 <- recent_quakes |> 
    filter(time > (now_nz - hours(24)))
n_24 <- nrow(last_24)
hours_last <- round(difftime(now_nz, recent_quakes$time[1], units = "hours"))
```

```{r}
#| label: "Quake map"
mag_pal <- colorBin("inferno", domain = 1:8, bins = c(0:5, 8))

quake_map <- recent_quakes |> 
  leaflet() |> 
  addCircleMarkers(
    color = ~ mag_pal(magnitude),
    stroke = FALSE,
    fillOpacity = 0.5,
    radius = ~ scales::rescale(sqrt(magnitude), c(1, 10)),
    label = ~ paste(
      date(time), pretty_time, "<br/>",
      "Magnitude:", round(magnitude, 1), "<br/>", 
      "Depth:",  round(depth), " km"
      ) |> map(html),
    labelOptions = c(textsize = "15px")) |> 
  addLegend(title = "Magnitude", colors = mag_pal(0:5), labels = c("<1", 1:4,">5")) |> 
  addTiles("http://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}", options = tileOptions(minZoom = 5, maxZoom = 10)) 
```

```{r}
#| label: "Quake histogram"
mag_hist <- recent_quakes |> 
  ggplot(aes(x = magnitude)) +
  geom_histogram()
```

```{r}
#| label: "Quake timeline"
timeline <- recent_quakes |> 
  ggplot(aes(x = time, y = 0)) +
  geom_point()
```

```{r}
#| label: "Recent quakes table"
n <- 10
top_n <- recent_quakes |> 
  slice(1:n) |> 
  as.data.frame() |> 
  select(magnitude, days_ago, pretty_time, locality, depth) 

top_n_table <- top_n |> 
  gt() |> 
  cols_label(
    days_ago = "",
    locality = "Location",
    magnitude = "Magnitude",
    depth = "Depth",
    pretty_time = ""
  ) |> 
  fmt_integer(
    columns = depth, 
    pattern = "{x} km"
  ) |> 
  fmt_number(
    columns = magnitude,
    decimals = 1
  ) |> 
  data_color(
    columns = "magnitude",
    fn = mag_pal
  ) |>
  tab_header(
    title = md("**Last 10 Earthquakes**")
  ) |> 
  tab_source_note(
    source_note = md(paste("Retrieved from the [GeoNet API](https://api.geonet.org.nz/) at", format(now_nz, "%Y/%m/%d %H:%M %Z")))
  )
```

# Dashboard

## Column 1 {height = 50%}

### 
```{r}
#| component: valuebox
#| title: Number of Hours since last Earthquake
list(icon = "clock-history", color = "primary", value = as.numeric(hours_last))

```

```{r}
#| component: valuebox
#| title: Number of Earthquakes in the last 24 hours
list( icon = "activity", color = "primary", value = n_24)
```

### Sub-Column
```{r}
#| title: Top 10 Earthquakes
#| component: table
#| echo: false
top_n_table



```

## Column 2 {height = 100%}
```{r}
quake_map
```


# About the Data
The original author of this dashboard is **Charlotte Wickham**.  
The data on earthquakes is drawn from the **GeoNet API**: <https://api.geonet.org.nz/>  
All earthquakes below **MMI 3.0** have been filtered out.

**References**

- <https://github.com/berkeley-stat133/demo-dashboard>  
- <https://api.geonet.org.nz/>  
- <https://quarto.org/docs/dashboards/theming.html>  
- <https://icons.getbootstrap.com/>
- [Shapefiles that ESRI ArcView GIS typically uses - they give you 8+ files but only read the .shp file- it will read the rest]<https://data.ca.gov/dataset/ca-geographic-boundaries>
- <https://quarto.org/docs/dashboards/theming.html>
- <https://bootswatch.com/>

### 
**Dashboard Requirements**

Starting from the contents of `demo-dashboard.qmd` found in the corresponding repo  
(<https://github.com/berkeley-stat133/demo-dashboard>), create a data dashboard that provides information on the most recent earthquakes to strike **New Zealand**.

The dashboard should include:

1. **Your name** added as the author.  
2. **A theme** of your choosing.  
   > Dashboards collect the colors and fonts into themes similar to ggplot2.  
   > You can find the list of themes here:  
   > <https://quarto.org/docs/dashboards/theming.html>.
3. **A layout in two columns.**
4. The **map of New Zealand** taking up the full right column.
5. The **left column** should have two rows:
   - The **top row** has **value boxes** for:
     - the **number of hours since the last earthquake**, and  
     - the **number of earthquakes in the last 24 hours**.  
       Select a suitable **icon** for each.
       > Quarto dashboards can use any of the icons in the Bootstrap collection.  
       > Search for an icon and use the corresponding name as a string:  
       > <https://icons.getbootstrap.com/>.
   - The **bottom row** should hold the **table of the top n earthquakes**.
6. All of the above should appear on a page called **“Dashboard.”**  
   Add a second page called **“About the data”** that displays the following text:

   > The original author of this dashboard is **Charlotte Wickham**.  
   >  
   > The data on earthquakes is drawn from the **GeoNet API**:  
   > <https://api.geonet.org.nz/>  
   >  
   > All earthquakes below **MMI 3.0** have been filtered out.

Since it is quite lengthy, there is **no need to copy the code** used in your dashboard into this problem set.